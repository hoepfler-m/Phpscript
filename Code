<?php
$servername = "localhost";
$username   = "root";
$password   = "";
$dbname     = "test";

$conn = new mysqli($servername, $username, $password, $dbname);

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

$meldung = "";

// POST-Request verarbeiten (Neuen Datensatz anlegen)
if ($_SERVER["REQUEST_METHOD"] === "POST") {

    $name   = trim($_POST["name"] ?? "");
    $vorname = trim($_POST["vorname"] ?? "");
    $email  = trim($_POST["email"] ?? "");
    $street = trim($_POST["street"] ?? "");
    $zip    = trim($_POST["zip"] ?? "");
    $city   = trim($_POST["city"] ?? "");

    // PLZ-Validierung
    if (strlen($zip) !== 5 || !ctype_digit($zip)) {
        $meldung = "Fehler: PLZ muss genau 5 Ziffern haben.";
    }

    // E-Mail-Validierung
    elseif (!str_contains($email, "@") || !str_contains($email, ".")) {
        $meldung = "Fehler: Ungültige E-Mail. Muss @ und . enthalten.";
    }

    // Pflichtfelder prüfen
    elseif ($name === "" || $vorname === "" || $email === "" || $street === "" || $city === "") {
        $meldung = "Fehler: Bitte alle Felder ausfüllen.";
    }

    // Wenn alles OK ist, in die Datenbank schreiben
    else {
        // users einfügen
        $stmtUser = $conn->prepare(
            "INSERT INTO users (name, vorname, email) VALUES (?, ?, ?)"
        );
        $stmtUser->bind_param("sss", $name, $vorname, $email);

        if ($stmtUser->execute()) {
            $userId = $stmtUser->insert_id;
            $stmtUser->close();

            // adresse einfügen
            $stmtAdr = $conn->prepare(
                "INSERT INTO adresse (street, zip, city) VALUES (?, ?, ?)"
            );
            $stmtAdr->bind_param("sss", $street, $zip, $city);

            if ($stmtAdr->execute()) {
                $adresseId = $stmtAdr->insert_id;
                $stmtAdr->close();

                // Verknüpfung in users_adresse einfügen
                $stmtLink = $conn->prepare(
                    "INSERT INTO users_adresse (users_id, adresse_id) VALUES (?, ?)"
                );
                $stmtLink->bind_param("ii", $userId, $adresseId);

                if ($stmtLink->execute()) {
                    $meldung = "Datensatz erfolgreich gespeichert.";
                } else {
                    $meldung = "Fehler beim Speichern (users_adresse): " . $stmtLink->error;
                }
                $stmtLink->close();
            } else {
                $meldung = "Fehler beim Speichern (adresse): " . $stmtAdr->error;
            }
        } else {
            $meldung = "Fehler beim Speichern (users): " . $stmtUser->error;
        }
    }
}

// OPTIONAL: Hier später Action-Handling einbauen (edit / copy / delete)
// $action    = $_GET['action']    ?? null;
// $userId    = isset($_GET['user_id']) ? (int)$_GET['user_id'] : 0;
// $adresseId = isset($_GET['adresse_id']) ? (int)$_GET['adresse_id'] : 0;

// DATENBANK AUSLESEN
$sql = "
    SELECT 
        users.id,
        users.name,
        users.vorname,
        users.email,
        adresse.id AS adresse_id,
        adresse.street,
        adresse.zip,
        adresse.city
    FROM users
    INNER JOIN users_adresse
        ON users.id = users_adresse.users_id
    INNER JOIN adresse
        ON adresse.id = users_adresse.adresse_id
";
$result = $conn->query($sql);
?>
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Benutzer & Adressen</title>
</head>
<body>
<h1>Benutzer-Verwaltung</h1>

<?php if ($meldung): ?>
    <p><strong><?php echo htmlspecialchars($meldung, ENT_QUOTES, 'UTF-8'); ?></strong></p>
<?php endif; ?>

<!-- Button zum Ein-/Ausblenden des Formulars -->
<button type="button" onclick="toggleForm()">Datensatz hinzufügen</button>

<!-- Formular-Container (anfangs versteckt) -->
<div id="formular-container" style="display:none; margin-top: 20px;">
    <h2>Neuen Datensatz anlegen</h2>
    <form method="post" action="">
        <label>Nachname:
            <input type="text" name="name" required>
        </label><br><br>

        <label>Vorname:
            <input type="text" name="vorname" required>
        </label><br><br>

        <label>E-Mail:
            <input type="email" name="email" required>
        </label><br><br>

        <label>Straße:
            <input type="text" name="street" required>
        </label><br><br>

        <label>PLZ:
            <input type="text" name="zip" required>
        </label><br><br>

        <label>Stadt:
            <input type="text" name="city" required>
        </label><br><br>

        <button type="submit">Speichern</button>
    </form>
</div>

<h2>Vorhandene Datensätze</h2>
<table border="1" cellpadding="5" cellspacing="0">
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Vorname</th>
        <th>E-Mail</th>
        <th>Straße</th>
        <th>PLZ</th>
        <th>Stadt</th>
        <th>Aktionen</th>
    </tr>
    <?php
    if ($result && $result->num_rows > 0) {
        while ($row = $result->fetch_assoc()) {
            $userId    = (int)$row["id"];
            $adresseId = (int)$row["adresse_id"];

            echo "<tr>";
            echo "<td>" . htmlspecialchars($row["id"]) . "</td>";
            echo "<td>" . htmlspecialchars($row["name"]) . "</td>";
            echo "<td>" . htmlspecialchars($row["vorname"]) . "</td>";
            echo "<td>" . htmlspecialchars($row["email"]) . "</td>";
            echo "<td>" . htmlspecialchars($row["street"]) . "</td>";
            echo "<td>" . htmlspecialchars($row["zip"]) . "</td>";
            echo "<td>" . htmlspecialchars($row["city"]) . "</td>";

            echo "<td>";
            echo "<a href='?action=edit&user_id={$userId}&adresse_id={$adresseId}'>Bearbeiten</a> | ";
            echo "<a href='?action=copy&user_id={$userId}&adresse_id={$adresseId}'>Kopieren</a> | ";
            echo "<a href='?action=delete&user_id={$userId}&adresse_id={$adresseId}' onclick=\"return confirm('Diesen Datensatz wirklich löschen?');\">Löschen</a>";
            echo "</td>";

            echo "</tr>";
        }
    } else {
        echo "<tr><td colspan='8'>Keine Daten vorhanden.</td></tr>";
    }
    ?>
</table>

<script>
function toggleForm() {
    const container = document.getElementById('formular-container');
    if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
}
</script>

</body>
</html>
<?php
$conn->close();
?>
